# tracespace/tracespace TravisCI configuration

language: node_js

# lts/carbon used as default in explicit job entries
node_js:
  - 'lts/carbon'
  - 'lts/dubnium'
  - node

script:
  - npm test
  - npm run coverage:upload

cache:
  npm: true

_deploy_base: &_deploy_base
  provider: script
  skip_cleanup: true
  on:
    repo: tracespace/tracespace
    all_branches: true

# use build stages with "test" and "deploy" stages
# jobs for node_js versions above automatically added to matrix "test" stage
jobs:
  include:
    - # test that app builds all work
      stage: test
      name: App builds
      script: npm run build

    - # greenkeeper-lockfile
      if: branch =~ ^greenkeeper
      stage: test
      name: Greenkeeper lockfile update
      before_install: npm i -g npm@latest greenkeeper-lockfile@2
      install: npm install
      before_script: greenkeeper-lockfile-update
      after_script: greenkeeper-lockfile-upload

    - # package deploy to npm on tagged commits
      if: tag =~ ^v
      stage: deploy
      name: Deploy packages to npm
      script: npm run example && npm run docs
      # set npm credentials for npm publish
      before_deploy:
        - npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
        - export NPM_TAG=$(node scripts/get-npm-tag.js $TRAVIS_TAG)
      deploy:
        <<: *_deploy_base
        script: npm run publish:npm

    - # apps deploy to s3 on master (staging) and tagged commits (production)
      if: tag =~ ^v OR (branch = master AND type != pull_request)
      stage: deploy
      name: Deploy apps to s3
      script: npm run build
      # set bucket for deploy
      before_deploy:
        - |
          if [ $TRAVIS_BRANCH = master ]; then
            export AWS_S3_BUCKET=$AWS_S3_BUCKET_STAGING
          else
            export AWS_S3_BUCKET=$AWS_S3_BUCKET_PRODUCTION
          fi
      deploy:
        <<: *_deploy_base
        script: npm run publish:s3
